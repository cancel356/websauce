angular.module("opensauce",["ngResource","ui.router","opensauce.filters","opensauce.services","opensauce.directives","opensauce.controllers"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){t.otherwise("/"),e.state("home",{url:"/",templateUrl:"/template/home.html",controller:"HomeController"}).state("sauce",{url:"/sauce",templateUrl:"/template/sauces.html",controller:"SaucesController"}).state("saucedetail",{url:"/sauce/:name",templateUrl:"/template/sauce.html",controller:"SauceController",data:{title:"{{recipe.title}}"},resolve:{recipe:["$stateParams","Recipe",function(e,t){return t.get({name:e.name})}]}}).state("gallery",{url:"/gallery",templateUrl:"/template/gallery.html",controller:"GalleryController"}).state("flavor",{url:"/flavor",templateUrl:"/template/flavors.html",controller:"FlavorsController"}).state("user",{url:"/user",templateUrl:"/template/users.html",controller:"UsersController"}).state("lab",{url:"/lab",templateUrl:"/template/lab.html",controller:"LabController"}).state("mixer",{url:"/lab/mixer",templateUrl:"/template/mix.html",controller:"MixerController"}).state("armageddon",{url:"/lab/armageddon",templateUrl:"/template/armageddon.html",controller:"ArmageddonController"}).state("about",{url:"/about",templateUrl:"/template/about.html",controller:"AboutController"}),n.html5Mode(!0).hashPrefix("!")}]),angular.module("opensauce.controllers",[]).controller("HomeController",["$scope","Recipe",function(e,t){console.log("asd"),e.recipes=t.query()}]).controller("SaucesController",["$scope","Recipe",function(e,t){e.recipes=t.query()}]).controller("SauceController",["$scope","Recipe","recipe",function(e,t,n){e.recipe=n}]).controller("GalleryController",["$http","$scope",function(e,t){e.get("http://localhost:3000/api/photos").success(function(e){t.photos=e})}]).controller("FlavorsController",["$scope","Ingredient",function(e,t){e.ingredients=t.query()}]).controller("UsersController",["$http","$scope",function(e,t){e.get("http://localhost:3000/api/users").success(function(e){t.users=e})}]).controller("LabController",["$http","$scope",function(){}]).controller("ArmageddonController",["$http","$scope",function(e,t){function n(e){e.fixed=!0,d3.select(this).classed("fixed",!0)}function r(e,t){var n=d3.layout.force().charge(-1500).linkDistance(120).linkStrength(function(){return.75}).size([e,t]).linkDistance(function(){return 120});return n}function i(e,t,n,r,i){e.stop().nodes(t).links(n).start(),e.on("tick",function(){o(r,i)})}function o(e,t){e.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),t.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y})}function c(e){d3.json("/api/lab/spectrum",function(t){x.ingredients=t,d=e.selectAll("circle.ingredient").data(t).enter().append("circle").attr("class","ingredientNodes").attr("title",function(e){return e.name}).attr("r",5).attr("cx",function(e){return 120+e.distance*parseFloat(e.cosine)}).attr("cy",function(e){return 480+e.distance*parseFloat(e.sine)}).style("fill",function(e){return e.color})})}function a(e,n,r,i,c,a){var l=[],s=[];r.each(function(e,t){var n={iIndex:-1,nIndex:t,distance:1e3};i.each(function(t,r){var i=Math.sqrt(Math.pow(e.x-$(this).attr("cx"),2)+Math.pow(e.y-$(this).attr("cy"),2));i<n.distance&&-1==s.indexOf(r)&&(n.distance=i,n.iIndex=r)}),s.push(n.iIndex),l.push(n)}),l.sort(function(e,t){return e.distance-t.distance}),v=[],m=[],f=[],$(l).each(function(l,s){f.push(x.ingredients[s.iIndex].id),v.push(e[s.nIndex]),m.push(e[s.nIndex].name);var u=e[s.nIndex].pure;$.each(u,function(e,n){$.each(t.stories,function(e,t){t.title==n&&t.ingredients.push(x.ingredients[s.iIndex].id)})}),r.select(function(e,t){return t==s.nIndex?this:null}).transition().delay(0).duration(a).call(function(){c.stop()}).tween("position",function(e){var t=$(i[0][s.iIndex]),c=t.attr("cX"),a=t.attr("cY"),l=d3.interpolate(e.px,c),u=d3.interpolate(e.py,a),d=d3.interpolate($(this).attr("r"),12),f=d3.interpolate($(this).css("fill"),t.css("fill"));return $(this).attr("title",$(this).attr("title")+" / "+t.attr("title")),function(t){$(this).attr("r",d(t)).css("fill",f(t)),e.px=l(t),e.py=u(t),e.x=l(t),e.y=u(t),e.fixed=!0,o(r,n)}}).call(function(){o(r,n),c.start()})})}function l(e,t){var n=e.selectAll("line.link").data(t).attr("class","link").style("stroke-width",function(){return 2});return n.enter().append("line").attr("class","link").style("stroke-width",function(){return 2}),n.exit().remove(),n}function s(e,t){var n=e.selectAll("circle.node").data(t).attr("class","node").attr("title",function(e){return e.name+" ("+e.pure.join(" ")+")"}).attr("r",6).style("fill","grey");return n.enter().append("circle").attr("class","node").attr("title",function(e){return e.name+" ("+e.pure.join(" ")+")"}).attr("r",6).style("fill","grey").call(p),n.exit().remove(),n}function u(e,t,n,r){var o=x.nodes=n,c=x.links=r,u=l(e,c),f=s(e,o);i(t,o,c,f,u),setTimeout(function(){a(o,u,f,d,t,5e3)},1e4)}var d,f,p,h,g,m=[],v=[],x={};t.stories=[{title:"",text:"",ingredients:[]}],t.upload=function(){e({method:"POST",url:"http://localhost:3000/api/lab/text/parse",data:t.stories}).success(function(e){u(g,h,e.nodes,e.links)})},t.add=function(e){t.stories.splice(t.stories.indexOf(e)+1,0,{title:"",text:"",ingredients:[]})},t.remove=function(e){t.stories.splice(t.stories.indexOf(e),1)},t.save=function(){console.log(t.stories),e({method:"POST",url:"http://localhost:3000/api/lab/text/save",data:t.stories}).success(function(){t.stories=[{title:"",text:"",ingredients:[]}]})},$(document).ready(function(){var e=600,t=600,i=$("#hover");g=d3.select("#sauce").append("svg").attr("width",e).attr("height",t),h=r(e,t),p=h.drag().on("dragstart",n),c(g),$("#sauce").on("mouseenter","circle",function(){i.show().html($(this).attr("title")).offset({top:$(this).offset().top-i.outerHeight(),left:$(this).offset().left-12})}).on("mouseleave","circle",function(){i.hide()})})}]).controller("MixerController",["$scope","Ingredient","Recipe","RecipeMaker",function(e,t,n,r){e.ingredients=t.query(),e.$watch("name",function(e){r.setTitle(e)}),e.save=function(){n.save({},{title:r.getTitle(),ingredients:r.getIngredients()},function(){e.name="",r.init()})}}]).controller("AboutController",["$http","$scope",function(){}]),angular.module("opensauce.directives",[]).directive("mainmenu",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<nav class="menu" ng-transclude></nav>',link:function(e,t){t.on("click",".menuButton",function(){alert(123)})}}}).directive("recipe",function(){return{restrict:"E",replace:!0,scope:{recipe:"="},template:'<li class="recipe"><a ui-sref="sauce({ name: recipe.name })"><div class="recipeName">{{recipe.title}}</div></a><div class="recipeAuthor">{{recipe.account.name}}</div><canvas class="recipeBackground"></canvas></li>',link:function(e,t){function n(){for(var t=4,n=o/2-t,r=e.recipe.ingredients,c=r.length,a=0,l=0;l<1.98*Math.PI;){var s=r[parseInt(Math.random()*c)];l+=Math.asin((a+6)/200)+Math.asin((t+6)/200),i.beginPath(),i.arc(n*Math.sin(l)+o/2,n*Math.cos(l)+o/2,t,0,2*Math.PI,!1),i.fillStyle=s.color,i.fill(),a=t}}var r=t.find(".recipeBackground")[0],i=r.getContext("2d"),o=t.outerWidth();r.height=o,r.width=o,e.$watch("recipe",function(t){e.recipe=t,e.recipe.ingredients&&n()})}}}).directive("ingredient",function(){return{restrict:"E",replace:!0,scope:{ingredient:"="},template:'<li class="ingredient"><div class="ingredientNameBefore"></div><div class="ingredientName">{{ingredient.name}}</div></li>',link:function(e,t){function n(e){return parseInt(o(e).substring(0,2),16)}function r(e){return parseInt(o(e).substring(2,4),16)}function i(e){return parseInt(o(e).substring(4,6),16)}function o(e){return"#"==e.charAt(0)?e.substring(1,7):e}e.$watch("ingredient",function(e){var o=e.color,c=n(o),a=r(o),l=i(o),s=(c+a+l)/3;console.log(o),t.css({backgroundColor:o,color:144>s?"white":"black"})})}}}).directive("wheel",["ZenFactory","RecipeMaker",function(e,t){return{restrict:"E",scope:{ingredients:"="},link:function(n,r){function i(e){e.forEach(function(e){e.selected&&(e.selected=!1)})}function o(e,t){var n=d3.rgb(e.color).hsl().h,r=d3.rgb(t.color).hsl().h;return n-r}function c(){u=v.selectAll("circle.ingredient").data(n.ingredients).attr("r",function(e){return e.selected?p+2:p}).style("stroke",function(e){return e.selected?e.color:"transparent"}).style("fill",function(e){return e.selected?"transparent":e.color}),u.enter().append("circle").attr("class","ingredient").attr("r",p).attr("cx",function(e,t){return(t%2===0?h:g)*Math.sin(t*s*(Math.PI/180))+d/2}).attr("cy",function(e,t){return(t%2===0?h:g)*Math.cos(t*s*(Math.PI/180))+f/2}).style("fill",function(e){return e.color})}function a(){u.on("mousedown",function(e){d3.event.preventDefault(),d3.event.stopPropagation(),e.selected=e.selected?!1:!0,e.selected?t.addIngredient(e.id):t.removeIngredient(e.id),m.setNodes(e,e.selected?24:0),c()})}function l(){c(),a()}var s,u,d=640,f=640,p=8,h=d/2-3*p,g=d/2-p,m=e,v=d3.select("#"+r.attr("id")).append("svg").attr("width",d).attr("height",f);m.init(v,d,f),n.recipeMaker=t,n.$watch("recipeMaker.getIngredients()",function(e,t){0!==t.length&&0===e.length&&(m.removeNodes(),i(n.ingredients),c())}),n.ingredients.$promise.then(function(e){n.ingredients=e.sort(o),s=360/n.ingredients.length,l()})}}}]).directive("headertitle",["$state","$interpolate",function(e,t){return{restrict:"E",replace:!0,template:'<h1 class="headertitle"><a class="breadcrumb"><span ng-repeat="crumb in breadcrumbs">{{crumb.displayName}}:</span></a></h1>',link:function(n){function r(){for(var t=[],r=e.$current;r&&""!==r.name;){if(r){var o=i(r);t.push({displayName:o,route:r.name})}r=r.parent}t.push({displayName:"opensauce",route:"home"}),t.reverse(),n.breadcrumbs=t}function i(e){var n,r,i;return console.log(e),r=o("data.title",e),console.log(r),r===!1?!1:"undefined"==typeof r?e.name:(n="undefined"!=typeof e.locals?e.locals.globals:e,i=t(r)(n))}function o(e,t){var n,r=e.split("."),i=t;for(n=0;n<r.length;n++){if(!angular.isDefined(i[r[n]]))return void 0;i=i[r[n]]}return i}n.breadcrumbs=[],""!==e.$current.name&&r(),n.$on("$stateChangeSuccess",function(){r()})}}}]),angular.module("opensauce.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]),angular.module("opensauce.services",[]).value("version","0.1").factory("Ingredient",["$resource",function(e){var t=e("http://www.opensauce.cz/api/ingredient/:name",{},{});return t}]).factory("Recipe",["$resource",function(e){var t=e("http://www.opensauce.cz/api/recipe/:name",{},{});return t}]).service("RecipeMaker",function(){var e=[],t="";this.init=function(){e=[],t=""},this.getIngredients=function(){return e},this.addIngredient=function(t){-1===e.indexOf(t)&&e.push(t)},this.removeIngredient=function(t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)},this.getTitle=function(){return t},this.setTitle=function(e){t=e}}).factory("ZenFactory",function(){function e(){t(),c()}function t(){m=[{ingredient:0,radius:1,color:"transparent",hue:0}]}function n(e,t){var n=e.id,r=e.color,i=d3.rgb(e.color).hsl().h,o=[];$.each(m,function(e,t){t.ingredient==n&&o.push(e)});var a=t-o.length;if(o.reverse(),v.stop(),0>a)for(var l=0;l<Math.abs(a);l++)m.splice(o[l],1);else m=m.concat(d3.range(a).map(function(){return{ingredient:n,radius:6,color:r,hue:i}}));c(),v.nodes(m).start()}function r(e,n,r){p=e,f=n,d=r,t(),c(),a(),o(.04,-1e3)}function i(e){var t=e.radius+16,n=e.x-t,r=e.x+t,i=e.y-t,o=e.y+t;return function(t,c,a,l,s){if(t.point&&t.point!==e){var u=e.x-t.point.x,d=e.y-t.point.y,f=Math.sqrt(u*u+d*d),p=e.radius+e.ingredient%10/4*Math.random()+t.point.radius;p>f&&(f=(f-p)/f*.5,e.x-=u*=f,e.y-=d*=f,t.point.x+=u,t.point.y+=d)}return c>r||n>l||a>o||i>s}}function o(e,t){v=d3.layout.force().gravity(e).charge(function(e,n){return 0==n?t:0}).nodes(m).size([f,d]),m[0]&&(g=m[0],g.radius=0,g.fixed=!0),v.on("tick",function(){for(var e=d3.geom.quadtree(m),t=0,n=m.length;++t<n;)e.visit(i(m[t]));p.selectAll("circle.zen").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}),v.start()}function c(){h=p.selectAll("circle.zen").data(m).attr("r",function(e){return e.radius}).style("fill",function(e){return e.color}),h.enter().append("svg:circle").attr("class","zen").attr("r",function(e){return e.radius}).style("fill",function(e){return e.color}),h.exit().remove()}function a(){var e=!1;p.on("mousedown",function(){e=!0,l(this,!1,0)}),p.on("mousemove",function(){e&&s(this,!1)}),p.on("mouseup",function(){e&&(e=!1,u())}),h.on("mousedown",function(t){d3.event.preventDefault(),d3.event.stopPropagation(),e=!0,l(p,!1,t.index)})}function l(e,t,n){if(v.stop().charge(function(e){return e.index==n?-640:0}),g.fixed=!1,g=m[n],g.fixed=!0,0==n){var r;r=t?d3.touches(e)[0]:d3.mouse(e),g.px=r[0],g.py=r[1]}v.start()}function s(e,t){var n;n=t?d3.touches(e)[0]:d3.mouse(e),g.px=n[0],g.py=n[1],v.resume()}function u(){v.stop().charge(0),g.fixed=!1,g=m[0],g.fixed=!0,v.start()}var d,f,p,h,g,m,v,x={init:r,removeNodes:e,setNodes:n};return x});