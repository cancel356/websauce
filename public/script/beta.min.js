angular.module("opensauce",["ngResource","ui.router","opensauce.filters","opensauce.services","opensauce.directives","opensauce.controllers"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){t.otherwise("/"),e.state("opensauce",{url:"/",views:{"header@":{templateUrl:"/template/header.html"},"main@":{templateUrl:"/template/home.html",controller:"HomeController"}},resolve:{recipes:["Recipe",function(e){return e.query()}]}}).state("sauce",{parent:"opensauce",url:"sauce",views:{"main@":{templateUrl:"/template/sauces.html",controller:"SaucesController"}}}).state("detail",{parent:"sauce",url:"/:name",views:{"main@":{templateUrl:"/template/sauce.html",controller:"SauceController"}},data:{title:"{{recipe.title}}"},resolve:{recipe:["$stateParams","Recipe",function(e,t){return t.get({name:e.name}).$promise}],forks:["$stateParams","Recipe",function(e,t){return t.forks({name:e.name})}],photos:["$stateParams","Recipe",function(e,t){return t.photos({name:e.name})}],comments:["$stateParams","Recipe",function(e,t){return t.comments({name:e.name})}]}}).state("gallery",{parent:"opensauce",url:"gallery",views:{"main@":{templateUrl:"/template/gallery.html",controller:"GalleryController"}}}).state("flavors",{parent:"opensauce",url:"flavor",views:{"main@":{templateUrl:"/template/flavors.html",controller:"FlavorsController"}}}).state("flavor",{parent:"flavors",url:"/:name",views:{"main@":{templateUrl:"/template/flavor.html",controller:"FlavorController"}}}).state("users",{parent:"opensauce",url:"user",views:{"main@":{templateUrl:"/template/users.html",controller:"UsersController"}}}).state("user",{parent:"users",url:"/:name",views:{"main@":{templateUrl:"/template/user.html",controller:"UserController"}}}).state("lab",{parent:"opensauce",url:"lab",views:{"main@":{templateUrl:"/template/lab.html",controller:"LabController"}}}).state("mixer",{parent:"lab",url:"/mixer",views:{"main@":{templateUrl:"/template/mix.html",controller:"MixerController"}}}).state("armageddon",{parent:"lab",url:"/armageddon",views:{"main@":{templateUrl:"/template/armageddon.html",controller:"ArmageddonController"}}}).state("about",{parent:"opensauce",url:"about",views:{"main@":{templateUrl:"/template/about.html",controller:"AboutController"}}}),n.html5Mode(!0).hashPrefix("!")}]),angular.module("opensauce.controllers",[]).controller("HomeController",["$scope","recipes",function(e,t){e.recipes=t}]).controller("SaucesController",["$scope","recipes",function(e,t){e.recipes=t}]).controller("SauceController",["$scope","recipe","forks","photos","comments","Recipe",function(e,t,n,r,o,i){e.recipe=t,e.forks=i.forks({name:t.name}),e.photos=i.photos({name:t.name}),e.comments=i.comments({name:t.name})}]).controller("GalleryController",["$http","$scope","Photo",function(e,t,n){t.photos=n.query()}]).controller("FlavorsController",["$scope","Ingredient",function(e,t){e.ingredients=t.query()}]).controller("UsersController",["$http","$scope","User",function(e,t,n){t.users=n.query()}]).controller("LabController",["$http","$scope",function(){}]).controller("ArmageddonController",["$http","$scope",function(e,t){function n(e){e.fixed=!0,d3.select(this).classed("fixed",!0)}function r(e,t){var n=d3.layout.force().charge(-1500).linkDistance(120).linkStrength(function(){return.75}).size([e,t]).linkDistance(function(){return 120});return n}function o(e,t,n,r,o){e.stop().nodes(t).links(n).start(),e.on("tick",function(){i(r,o)})}function i(e,t){e.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),t.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y})}function a(e){d3.json("/api/lab/spectrum",function(t){y.ingredients=t,d=e.selectAll("circle.ingredient").data(t).enter().append("circle").attr("class","ingredientNodes").attr("title",function(e){return e.name}).attr("r",5).attr("cx",function(e){return 120+e.distance*parseFloat(e.cosine)}).attr("cy",function(e){return 480+e.distance*parseFloat(e.sine)}).style("fill",function(e){return e.color})})}function s(e,n,r,o,a,s){var c=[],l=[];r.each(function(e,t){var n={iIndex:-1,nIndex:t,distance:1e3};o.each(function(t,r){var o=Math.sqrt(Math.pow(e.x-$(this).attr("cx"),2)+Math.pow(e.y-$(this).attr("cy"),2));o<n.distance&&-1==l.indexOf(r)&&(n.distance=o,n.iIndex=r)}),l.push(n.iIndex),c.push(n)}),c.sort(function(e,t){return e.distance-t.distance}),v=[],g=[],f=[],$(c).each(function(c,l){f.push(y.ingredients[l.iIndex].id),v.push(e[l.nIndex]),g.push(e[l.nIndex].name);var u=e[l.nIndex].pure;$.each(u,function(e,n){$.each(t.stories,function(e,t){t.title==n&&t.ingredients.push(y.ingredients[l.iIndex].id)})}),r.select(function(e,t){return t==l.nIndex?this:null}).transition().delay(0).duration(s).call(function(){a.stop()}).tween("position",function(e){var t=$(o[0][l.iIndex]),a=t.attr("cX"),s=t.attr("cY"),c=d3.interpolate(e.px,a),u=d3.interpolate(e.py,s),d=d3.interpolate($(this).attr("r"),12),f=d3.interpolate($(this).css("fill"),t.css("fill"));return $(this).attr("title",$(this).attr("title")+" / "+t.attr("title")),function(t){$(this).attr("r",d(t)).css("fill",f(t)),e.px=c(t),e.py=u(t),e.x=c(t),e.y=u(t),e.fixed=!0,i(r,n)}}).call(function(){i(r,n),a.start()})})}function c(e,t){var n=e.selectAll("line.link").data(t).attr("class","link").style("stroke-width",function(){return 2});return n.enter().append("line").attr("class","link").style("stroke-width",function(){return 2}),n.exit().remove(),n}function l(e,t){var n=e.selectAll("circle.node").data(t).attr("class","node").attr("title",function(e){return e.name+" ("+e.pure.join(" ")+")"}).attr("r",6).style("fill","grey");return n.enter().append("circle").attr("class","node").attr("title",function(e){return e.name+" ("+e.pure.join(" ")+")"}).attr("r",6).style("fill","grey").call(p),n.exit().remove(),n}function u(e,t,n,r){var i=y.nodes=n,a=y.links=r,u=c(e,a),f=l(e,i);o(t,i,a,f,u),setTimeout(function(){s(i,u,f,d,t,5e3)},1e4)}var d,f,p,m,h,g=[],v=[],y={};t.stories=[{title:"",text:"",ingredients:[]}],t.upload=function(){e({method:"POST",url:"http://localhost:3000/api/lab/text/parse",data:t.stories}).success(function(e){u(h,m,e.nodes,e.links)})},t.add=function(e){t.stories.splice(t.stories.indexOf(e)+1,0,{title:"",text:"",ingredients:[]})},t.remove=function(e){t.stories.splice(t.stories.indexOf(e),1)},t.save=function(){console.log(t.stories),e({method:"POST",url:"http://localhost:3000/api/lab/text/save",data:t.stories}).success(function(){t.stories=[{title:"",text:"",ingredients:[]}]})},$(document).ready(function(){var e=600,t=600,o=$("#hover");h=d3.select("#sauce").append("svg").attr("width",e).attr("height",t),m=r(e,t),p=m.drag().on("dragstart",n),a(h),$("#sauce").on("mouseenter","circle",function(){o.show().html($(this).attr("title")).offset({top:$(this).offset().top-o.outerHeight(),left:$(this).offset().left-12})}).on("mouseleave","circle",function(){o.hide()})})}]).controller("MixerController",["$scope","Ingredient","Recipe","RecipeMaker",function(e,t,n,r){e.ingredients=t.query(),e.$watch("name",function(e){r.setTitle(e)}),e.save=function(){n.save({},{title:r.getTitle(),ingredients:r.getIngredients()},function(){e.name="",r.init()})}}]).controller("AboutController",["$http","$scope",function(){}]),angular.module("opensauce.directives",[]).directive("mainmenu",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<nav class="menu" ng-transclude></nav>',link:function(e,t){t.on("click",".menuButton",function(){alert(123)})}}}).directive("recipeBackground",["ZenCanvasFactory",function(e){return{restrict:"C",scope:{recipe:"="},link:function(t,n){var r=n[0],o=n.outerWidth(),i=3,a=new e;a.init(r,o,o,i,[]),t.$watch("recipe",function(e){t.recipe=e;var n=e.ingredients;n.length&&a.setColors(n.map(function(e){return e.color}))})}}}]).directive("ingredientBackground",["ZenCanvasFactory",function(e){return{restrict:"C",scope:{ingredient:"="},link:function(t,n){var r=n[0],o=n.outerWidth(),i=2,a=new e;a.init(r,o,o,i,[]),t.$watch("ingredient",function(e){t.ingredient=e,a.setColors([e.color])})}}}]).directive("wheel",["ZenFactory","RecipeMaker",function(e,t){return{restrict:"E",scope:{ingredients:"="},link:function(n,r){function o(e){e.forEach(function(e){e.selected&&(e.selected=!1)})}function i(e,t){var n=d3.rgb(e.color).hsl().h,r=d3.rgb(t.color).hsl().h;return n-r}function a(){u=v.selectAll("circle.ingredient").data(n.ingredients).attr("r",function(e){return e.selected?p+2:p}).style("stroke",function(e){return e.selected?e.color:"transparent"}).style("fill",function(e){return e.selected?"transparent":e.color}),u.enter().append("circle").attr("class","ingredient").attr("r",p).attr("cx",function(e,t){return(t%2===0?m:h)*Math.sin(t*l*(Math.PI/180))+d/2}).attr("cy",function(e,t){return(t%2===0?m:h)*Math.cos(t*l*(Math.PI/180))+f/2}).style("fill",function(e){return e.color})}function s(){u.on("mousedown",function(e){d3.event.preventDefault(),d3.event.stopPropagation(),e.selected=!e.selected,e.selected?t.addIngredient(e.id):t.removeIngredient(e.id),g.setNodes(e,e.selected?24:0),a()})}function c(){a(),s()}var l,u,d=640,f=640,p=8,m=d/2-3*p,h=d/2-p,g=e,v=d3.select("#"+r.attr("id")).append("svg").attr("width",d).attr("height",f);g.init(v,d,f,[]),n.recipeMaker=t,n.$watch("recipeMaker.getIngredients()",function(e,t){0!==t.length&&0===e.length&&(g.removeNodes(),o(n.ingredients),a())}),n.ingredients.$promise.then(function(e){n.ingredients=e.sort(i),l=360/n.ingredients.length,c()})}}}]).directive("zen",["ZenFactory",function(e){return{restrict:"C",scope:{ingredients:"="},link:function(t,n){var r=n.outerWidth(),o=r,i=d3.select(n[0]).append("svg").attr("width",r).attr("height",o);e.init(i,r,o,t.ingredients)}}}]).directive("headertitle",["$state","$interpolate",function(e,t){return{restrict:"E",replace:!0,template:'<ul class="breadcrumbs"><li class="breadcrumb" ng-repeat="crumb in breadcrumbs" ng-class="{active: $last}"><a ui-sref="{{crumb.route}}" ng-if="!$last">{{crumb.displayName}}:</a><span ng-if="$last">{{crumb.displayName}}</span></li></ul>',link:function(n){function r(){for(var t=[],r=e.$current;r&&""!==r.name;){if(r){var i=o(r);t.push({displayName:i,route:r.name})}r=r.parent}t.reverse(),n.breadcrumbs=t}function o(e){var n,r,o;return console.log(e),r=i("data.title",e),console.log(r),r===!1?!1:"undefined"==typeof r?e.name:(n="undefined"!=typeof e.locals?e.locals.globals:e,o=t(r)(n))}function i(e,t){var n,r=e.split("."),o=t;for(n=0;n<r.length;n++){if(!angular.isDefined(o[r[n]]))return void 0;o=o[r[n]]}return o}n.breadcrumbs=[],""!==e.$current.name&&r(),n.$on("$stateChangeSuccess",function(){r()})}}}]),angular.module("opensauce.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]).filter("timeago",function(){return function(e,t){var n,r=function(e,t,n){var r=$.isFunction(e)?e(t,c):e,o=n.numbers&&n.numbers[t]||t;return r.replace(/%d/i,o)},o=(new Date).getTime(),i=new Date(e).getTime(),a=t||!1,s={prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"},c=o-i,l=Math.abs(c)/1e3,u=l/60,d=u/60,f=d/24,p=f/365,m=void 0===s.wordSeparator?" ":s.wordSeparator,h=s.prefixAgo,g=s.suffixAgo;return a&&0>c&&(h=s.prefixFromNow,g=s.suffixFromNow),n=45>l&&r(s.seconds,Math.round(l),s)||90>l&&r(s.minute,1,s)||45>u&&r(s.minutes,Math.round(u),s)||90>u&&r(s.hour,1,s)||24>d&&r(s.hours,Math.round(d),s)||42>d&&r(s.day,1,s)||30>f&&r(s.days,Math.round(f),s)||45>f&&r(s.month,1,s)||365>f&&r(s.months,Math.round(f/30),s)||1.5>p&&r(s.year,1,s)||r(s.years,Math.round(p),s),$.trim([h,n,g].join(m))}}).filter("diff",function(){return function(e,t){var n,r,o,i=t.ingredients,a=e.ingredients;return n=a.filter(function(e){return!i.some(function(t){return e.friendly==t.friendly})}),r=i.filter(function(e){return!a.some(function(t){return e.friendly==t.friendly})}),n.length?o="with "+n.map(function(e){return e.name}).join(" and "):r.length&&(o="without "+r.map(function(e){return e.name}).join(" and ")),o}}),angular.module("opensauce.services",[]).value("version","0.1").factory("Ingredient",["$resource",function(e){var t=e("http://localhost:3000/api/ingredient/:name",{},{});return t}]).factory("Recipe",["$resource",function(e){var t="http://localhost:3000/api/recipe/:name",n=e(t,{},{comments:{method:"GET",url:t+"/comments",isArray:!0},photos:{method:"GET",url:t+"/photos",isArray:!0},forks:{method:"GET",url:t+"/forks",isArray:!0}});return n}]).factory("Photo",["$resource",function(e){var t=e("http://localhost:3000/api/photo/:name",{},{});return t}]).factory("User",["$resource",function(e){var t=e("http://localhost:3000/api/user/:name",{},{});return t}]).service("RecipeMaker",function(){var e=[],t="";this.init=function(){e=[],t=""},this.getIngredients=function(){return e},this.addIngredient=function(t){-1===e.indexOf(t)&&e.push(t)},this.removeIngredient=function(t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)},this.getTitle=function(){return t},this.setTitle=function(e){t=e}}).factory("ZenCanvasFactory",function(){var e=function(){function e(e,s,c,l,u){i=e,r=s,n=c,o=l,a=i.getContext("2d"),s,i.height=s,i.width=s,u.length&&t(u)}function t(e){var t=r/2-o,n=e.length,i=0,s=0;for(console.log(e);s<1.98*Math.PI;){var c=e[parseInt(Math.random()*n)];console.log(c),s+=Math.asin((i+6)/200)+Math.asin((o+6)/200),a.beginPath(),a.arc(t*Math.sin(s)+r/2,t*Math.cos(s)+r/2,o,0,2*Math.PI,!1),a.fillStyle=c,a.fill(),i=o}}var n,r,o,i,a;return{init:e,setColors:t}};return e}).factory("ZenFactory",function(){function e(){t(),a()}function t(e){g=[{ingredient:0,radius:1,color:"transparent",hue:0}];var t=e.length?Math.round(480/e.length):0;$.each(e,function(e,n){g=g.concat(d3.range(t).map(function(){return{ingredient:n.id,radius:4,color:n.color,hue:d3.rgb(n.color).hsl().h}}))})}function n(e,t){var n=e.id,r=e.color,o=d3.rgb(e.color).hsl().h,i=[];$.each(g,function(e,t){t.ingredient==n&&i.push(e)});var s=t-i.length;if(i.reverse(),v.stop(),0>s)for(var c=0;c<Math.abs(s);c++)g.splice(i[c],1);else g=g.concat(d3.range(s).map(function(){return{ingredient:n,radius:5,color:r,hue:o}}));a(),v.nodes(g).start()}function r(e,n,r,o){p=e,f=n,d=r,t(o),a(),s(),i(.04,-1e3)}function o(e){var t=e.radius+16,n=e.x-t,r=e.x+t,o=e.y-t,i=e.y+t;return function(t,a,s,c,l){if(t.point&&t.point!==e){var u=e.x-t.point.x,d=e.y-t.point.y,f=Math.sqrt(u*u+d*d),p=e.radius+e.hue/48%4+4+t.point.radius;p>f&&(f=(f-p)/f*.5,e.x-=u*=f,e.y-=d*=f,t.point.x+=u,t.point.y+=d)}return a>r||n>c||s>i||o>l}}function i(e,t){v=d3.layout.force().gravity(e).charge(function(e,n){return 0===n?t:0}).nodes(g).size([f,d]),g[0]&&(h=g[0],h.radius=0,h.fixed=!0),v.on("tick",function(){for(var e=d3.geom.quadtree(g),t=0,n=g.length;++t<n;)e.visit(o(g[t]));p.selectAll("circle.zen").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}),v.start()}function a(){m=p.selectAll("circle.zen").data(g).attr("r",function(e){return e.radius}).style("fill",function(e){return e.color}),m.enter().append("svg:circle").attr("class","zen").attr("r",function(e){return e.radius}).style("fill",function(e){return e.color}),m.exit().remove()}function s(){var e=!1;p.on("mousedown",function(){e=!0,c(this,!1,0)}),p.on("mousemove",function(){e&&l(this,!1)}),p.on("mouseup",function(){e&&(e=!1,u())}),m.on("mousedown",function(t){d3.event.preventDefault(),d3.event.stopPropagation(),e=!0,c(p,!1,t.index)})}function c(e,t,n){if(v.stop().charge(function(e){return e.index==n?-640:0}),h.fixed=!1,h=g[n],h.fixed=!0,0===n){var r;r=t?d3.touches(e)[0]:d3.mouse(e),h.px=r[0],h.py=r[1]}v.start()}function l(e,t){var n;n=t?d3.touches(e)[0]:d3.mouse(e),h.px=n[0],h.py=n[1],v.resume()}function u(){v.stop().charge(0),h.fixed=!1,h=g[0],h.fixed=!0,v.start()}var d,f,p,m,h,g,v,y={init:r,removeNodes:e,setNodes:n};return y});